name: Deploy GitHub Pages

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build comparison site
        run: |
          set -euo pipefail

          # Fetch variant branches created via worktrees
          git fetch --no-tags origin alt-whisper-inline alt-whisper-modal || true

          mkdir -p site/variants/master site/variants/whisper-inline site/variants/whisper-modal

          # Baseline from current branch
          cp ve-boilerplate.html site/variants/master/index.html
          cp reading-styles.css site/variants/master/
          cp reading-script.js site/variants/master/

          # Whisper modal from branch
          if git rev-parse --verify --quiet origin/alt-whisper-modal >/dev/null; then
            git show origin/alt-whisper-modal:ve-boilerplate.html > site/variants/whisper-modal/index.html
            git show origin/alt-whisper-modal:reading-styles.css > site/variants/whisper-modal/reading-styles.css
            git show origin/alt-whisper-modal:reading-script.js > site/variants/whisper-modal/reading-script.js
          else
            echo "Missing branch origin/alt-whisper-modal; skipping modal variant"
          fi

          # Whisper inline from branch
          if git rev-parse --verify --quiet origin/alt-whisper-inline >/dev/null; then
            git show origin/alt-whisper-inline:ve-boilerplate.html > site/variants/whisper-inline/index.html
            git show origin/alt-whisper-inline:reading-styles.css > site/variants/whisper-inline/reading-styles.css
            git show origin/alt-whisper-inline:reading-script.js > site/variants/whisper-inline/reading-script.js
          else
            echo "Missing branch origin/alt-whisper-inline; skipping inline variant"
          fi

          # SHAs for meta
          master_sha=$(git rev-parse --short HEAD)
          modal_sha=$(git rev-parse --short origin/alt-whisper-modal 2>/dev/null || true)
          inline_sha=$(git rev-parse --short origin/alt-whisper-inline 2>/dev/null || true)

          cat > site/index.html <<HTML
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Reader Feedback Comparison</title>
              <style>
                  :root {
                      color-scheme: light;
                  }
                  body {
                      margin: 0;
                      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
                      background: #f8f9fa;
                      color: #202122;
                  }
                  .page {
                      max-width: 1200px;
                      margin: 0 auto;
                      padding: 2.5rem 1.5rem 3rem;
                  }
                  header {
                      margin-bottom: 2rem;
                  }
                  h1 {
                      margin: 0 0 0.25rem;
                      font-size: clamp(1.75rem, 4vw, 2.4rem);
                  }
                  p.lede {
                      margin: 0;
                      font-size: clamp(1rem, 2.8vw, 1.125rem);
                      color: #54595d;
                  }
                  .tablist {
                      display: flex;
                      flex-wrap: wrap;
                      gap: 0.5rem;
                      margin-bottom: 1.5rem;
                  }
                  .tab {
                      border: 1px solid #a2a9b1;
                      background: #ffffff;
                      border-radius: 999px;
                      padding: 0.55rem 1.25rem;
                      font-size: 0.95rem;
                      cursor: pointer;
                      color: #202122;
                      transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
                  }
                  .tab[aria-selected="true"] {
                      background: #3366cc;
                      border-color: #3366cc;
                      color: #fff;
                      box-shadow: 0 1px 4px rgba(51, 102, 204, 0.35);
                  }
                  .tab:focus-visible {
                      outline: 2px solid #36c;
                      outline-offset: 2px;
                  }
                  .panels {
                      position: relative;
                      min-height: 60vh;
                  }
                  .variant-frame {
                      width: 100%;
                      height: min(85vh, 960px);
                      border: 1px solid #a2a9b1;
                      border-radius: 12px;
                      background: #fff;
                      box-shadow: 0 4px 16px rgba(32, 33, 36, 0.12);
                      display: none;
                  }
                  .variant-frame.active {
                      display: block;
                  }
                  .meta {
                      margin-top: 1rem;
                      color: #72777d;
                      font-size: 0.85rem;
                      line-height: 1.4;
                  }
                  .meta code {
                      font-family: "SFMono-Regular", "Consolas", "Liberation Mono", monospace;
                      background: rgba(0, 0, 0, 0.04);
                      border-radius: 4px;
                      padding: 0.1rem 0.35rem;
                  }
                  @media (max-width: 768px) {
                      .page {
                          padding: 1.5rem 1rem 2.5rem;
                      }
                      .tablist {
                          gap: 0.4rem;
                      }
                      .tab {
                          flex: 1 1 auto;
                          text-align: center;
                      }
                      .variant-frame {
                          height: 75vh;
                      }
                  }
              </style>
          </head>
          <body>
              <div class="page">
                  <header>
                      <h1>Reader Feedback Variants</h1>
                      <p class="lede">Compare live prototypes side-by-side. Switch tabs to explore each feedback design without leaving the page.</p>
                  </header>

                  <div class="tablist" role="tablist" aria-label="Feedback design variants">
                      <button class="tab" role="tab" id="tab-master" data-target="master" aria-controls="panel-master" aria-selected="true">Baseline</button>
                      <button class="tab" role="tab" id="tab-modal" data-target="whisper-modal" aria-controls="panel-whisper-modal" aria-selected="false">Whisper Modal</button>
                      <button class="tab" role="tab" id="tab-inline" data-target="whisper-inline" aria-controls="panel-whisper-inline" aria-selected="false">Whisper Inline</button>
                  </div>

                  <div class="panels">
                      <iframe class="variant-frame active" id="panel-master" title="Master design" src="variants/master/index.html" loading="lazy"></iframe>
                      <iframe class="variant-frame" id="panel-whisper-modal" title="Whisper modal design" data-src="variants/whisper-modal/index.html" loading="lazy"></iframe>
                      <iframe class="variant-frame" id="panel-whisper-inline" title="Whisper inline design" data-src="variants/whisper-inline/index.html" loading="lazy"></iframe>
                  </div>

                  <div class="meta" id="variantMeta">
                      <div><strong>Master design</strong> • branch <code>master</code> • commit <code>${master_sha}</code></div>
                      <div><span aria-hidden="true">⤷</span> Use the tabs above to preview other treatments. Each loads the same article content with different feedback UI.</div>
                  </div>
              </div>

              <script>
                  const tabs = Array.from(document.querySelectorAll('.tab'));
                  const frames = new Map(Array.from(document.querySelectorAll('.variant-frame')).map(frame => [frame.id.replace('panel-', ''), frame]));
                  const meta = document.getElementById('variantMeta');
                  const branchMeta = {
                      master: { label: 'Baseline', branch: '${{ github.ref_name }}', commit: '${master_sha}' },
                      'whisper-modal': { label: 'Whisper Modal', branch: 'alt-whisper-modal', commit: '${modal_sha}' },
                      'whisper-inline': { label: 'Whisper Inline', branch: 'alt-whisper-inline', commit: '${inline_sha}' }
                  };

                  function activate(target) {
                      tabs.forEach(tab => {
                          const isActive = tab.dataset.target === target;
                          tab.setAttribute('aria-selected', String(isActive));
                      });

                      frames.forEach((frame, key) => {
                          const isActive = key === target;
                          frame.classList.toggle('active', isActive);
                          if (isActive && frame.dataset.src && !frame.dataset.loaded) {
                              frame.src = frame.dataset.src;
                              frame.dataset.loaded = 'true';
                          }
                      });

                      const info = branchMeta[target] || branchMeta.master;
                      const commitText = info.commit ? ' • commit <code>' + info.commit + '</code>' : '';
                      meta.innerHTML = '<div><strong>' + info.label + '</strong> • branch <code>' + info.branch + '</code>' + commitText + '</div>' +
                          '<div><span aria-hidden="true">⤷</span> Use the tabs above to preview other treatments. Each loads the same article content with different feedback UI.</div>';
                  }

                  tabs.forEach(tab => {
                      tab.addEventListener('click', () => activate(tab.dataset.target));
                      tab.addEventListener('keydown', event => {
                          if (event.key !== 'ArrowRight' && event.key !== 'ArrowLeft') {
                              return;
                          }
                          event.preventDefault();
                          const direction = event.key === 'ArrowRight' ? 1 : -1;
                          const index = tabs.indexOf(tab);
                          const next = tabs[(index + direction + tabs.length) % tabs.length];
                          next.focus();
                          activate(next.dataset.target);
                      });
                  });

                  activate('master');
              </script>
          </body>
          </html>
HTML

      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'site'
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
